<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UPD8.GROUP — Engine Test</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 40px 20px; }
    h1 { font-size: 20px; font-weight: 700; color: #f8fafc; margin-bottom: 4px; }
    .sub { font-size: 13px; color: #64748b; margin-bottom: 32px; }
    .card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 28px; width: 100%; max-width: 520px; }
    label { display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px; letter-spacing: 0.05em; }
    input[type="text"], input[type="file"], select { width: 100%; padding: 10px 12px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: #e2e8f0; font-size: 14px; margin-bottom: 18px; font-family: inherit; }
    input[type="file"] { padding: 8px 12px; cursor: pointer; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    button { width: 100%; padding: 14px; background: #16803c; color: #fff; border: none; border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; transition: background 0.15s; font-family: inherit; }
    button:hover:not(:disabled) { background: #14662f; }
    button:disabled { opacity: 0.4; cursor: not-allowed; }
    .log { margin-top: 24px; }
    .log-entry { padding: 10px 14px; border-radius: 6px; margin-bottom: 8px; font-size: 13px; font-family: 'Menlo','Courier New',monospace; line-height: 1.5; }
    .log-entry.info { background: #1e293b; border-left: 3px solid #3b82f6; color: #93c5fd; }
    .log-entry.ok   { background: #052e16; border-left: 3px solid #16a34a; color: #86efac; }
    .log-entry.err  { background: #1f0a0a; border-left: 3px solid #dc2626; color: #fca5a5; }
    .log-entry.wait { background: #1c1500; border-left: 3px solid #d97706; color: #fcd34d; }
    #reportWrap { display: none; margin-top: 24px; width: 100%; max-width: 760px; }
    #reportWrap iframe { width: 100%; border: 1px solid #334155; border-radius: 12px; background: #fff; min-height: 600px; }
    .report-actions { display: flex; gap: 10px; margin-bottom: 12px; justify-content: center; }
    .report-actions button { width: auto; padding: 10px 20px; font-size: 13px; }
    .btn-sec { background: #334155 !important; }
    .btn-sec:hover:not(:disabled) { background: #475569 !important; }
    .progress-bar { height: 3px; background: #0f172a; border-radius: 2px; margin-top: 12px; overflow: hidden; }
    .progress-fill { height: 100%; background: #16a34a; border-radius: 2px; width: 0%; transition: width 0.5s ease; }
  </style>
</head>
<body>

<h1>UPD8.GROUP — Engine Test</h1>
<p class="sub">Background function + polling architecture. Tests the full upload → analyse pipeline.</p>

<div class="card">
  <label>API KEY (from Bitwarden)</label>
  <input type="text" id="apiKey" placeholder="ll_... or vv_... or mm_...">

  <div class="row">
    <div>
      <label>PRODUCT</label>
      <select id="product">
        <option value="listinglens">Listing Lens</option>
        <option value="vehiclevibe">Vehicle Vibe</option>
        <option value="noforksgiven">No Forks Given</option>
      </select>
    </div>
    <div>
      <label>TIER</label>
      <select id="tier">
        <option value="standard">Standard</option>
        <option value="deep-dive">Deep Dive</option>
      </select>
    </div>
  </div>

  <label>SCREENSHOT (JPG or PNG)</label>
  <input type="file" id="screenshot" accept="image/jpeg,image/png,image/webp">

  <button id="runBtn" onclick="runTest()">Run Test</button>
  <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
  <div class="log" id="log"></div>
</div>

<div id="reportWrap">
  <div class="report-actions">
    <button onclick="downloadReport()">↓ Download Report</button>
    <button class="btn-sec" onclick="resetTest()">← New Test</button>
  </div>
  <iframe id="reportFrame" sandbox="allow-same-origin"></iframe>
</div>

<script>
var currentHtml = '';
var pollTimer   = null;

function log(msg, type) {
  var el = document.createElement('div');
  el.className = 'log-entry ' + (type || 'info');
  el.textContent = msg;
  document.getElementById('log').appendChild(el);
}
function setProgress(pct) { document.getElementById('progressFill').style.width = pct + '%'; }
function clearLog() { document.getElementById('log').innerHTML = ''; setProgress(0); }

// Convert a File to base64 string (no data-URL prefix)
function fileToBase64(file) {
  return new Promise(function(resolve, reject) {
    var reader = new FileReader();
    reader.onload  = function(e) { resolve(e.target.result.split(',')[1]); };
    reader.onerror = function(e) { reject(new Error('File read failed')); };
    reader.readAsDataURL(file);
  });
}

async function runTest() {
  var apiKey    = document.getElementById('apiKey').value.trim();
  var product   = document.getElementById('product').value;
  var tier      = document.getElementById('tier').value;
  var fileInput = document.getElementById('screenshot');

  if (!apiKey)             { log('Paste your API key first', 'err'); return; }
  if (!fileInput.files[0]) { log('Select a screenshot first', 'err'); return; }

  clearLog();
  document.getElementById('runBtn').disabled = true;
  document.getElementById('reportWrap').style.display = 'none';

  // ── Step 1: Convert image to base64 then upload as JSON ──────────────────
  log('Step 1/3 — Converting image to base64...', 'info');
  setProgress(5);

  var file = fileInput.files[0];
  var image_base64;
  try {
    image_base64 = await fileToBase64(file);
  } catch (e) {
    log('File read error: ' + e.message, 'err');
    document.getElementById('runBtn').disabled = false;
    return;
  }

  log('Step 1/3 — Uploading to Blobs...', 'info');
  setProgress(15);

  var uploadRes, uploadData;
  try {
    uploadRes  = await fetch('/api/upload', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ api_key: apiKey, image_base64: image_base64, mime_type: file.type })
    });
    uploadData = await uploadRes.json();
  } catch (e) {
    log('Upload network error: ' + e.message, 'err');
    document.getElementById('runBtn').disabled = false;
    return;
  }

  if (!uploadRes.ok) {
    log('Upload failed (' + uploadRes.status + '): ' + (uploadData.error || 'Unknown'), 'err');
    document.getElementById('runBtn').disabled = false;
    return;
  }

  var sessionId = uploadData.session_id;
  var blobId    = uploadData.blob_id;
  var jobId     = 'job_' + Date.now() + '_' + Math.random().toString(36).substring(2, 6);

  log('✓ Uploaded  session_id: ' + sessionId, 'ok');
  log('           blob_id:    ' + blobId,     'ok');
  log('           expires:    ' + (uploadData.expires_at || '15 min'), 'ok');
  log('           job_id:     ' + jobId, 'ok');
  setProgress(35);

  // ── Step 2: Fire background function (browser → background fn directly) ──
  log('Step 2/3 — Firing analyze-background (returns 202 immediately)...', 'info');

  try {
    var bgRes = await fetch('/.netlify/functions/analyze-background', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        api_key:    apiKey,
        job_id:     jobId,
        session_id: sessionId,
        blob_id:    blobId,
        product:    product,
        tier:       tier
      })
    });
    log('✓ Background function fired (HTTP ' + bgRes.status + ')', 'ok');
  } catch (e) {
    // Fetch may throw on 202 with closed connection — that's fine
    log('✓ Background function fired (connection closed — normal for 202)', 'ok');
  }

  setProgress(45);

  // ── Step 3: Poll /api/status every 3s ────────────────────────────────────
  log('Step 3/3 — Polling /api/status every 3s (max 3 min)...', 'wait');

  var attempts    = 0;
  var maxAttempts = 60;
  var pollStart   = Date.now();

  pollTimer = setInterval(async function() {
    attempts++;
    var elapsed = Math.round((Date.now() - pollStart) / 1000);

    try {
      var statusRes  = await fetch('/api/status?job_id=' + encodeURIComponent(jobId));
      var statusData = await statusRes.json();

      if (statusData.status === 'complete') {
        clearInterval(pollTimer);
        setProgress(100);
        log('✓ Report ready! (' + elapsed + 's, ' + (statusData.html ? statusData.html.length : 0) + ' chars)', 'ok');
        currentHtml = statusData.html || '';
        var frame = document.getElementById('reportFrame');
        frame.srcdoc = currentHtml;
        frame.onload = function() {
          try {
            var h = Math.max(frame.contentDocument.body.scrollHeight, frame.contentDocument.documentElement.scrollHeight);
            frame.style.height = (h > 200 ? h + 48 : 5000) + 'px';
          } catch(e) { frame.style.height = '5000px'; }
        };
        document.getElementById('reportWrap').style.display = 'block';
        document.getElementById('runBtn').disabled = false;
        window.scrollTo({ top: document.getElementById('reportWrap').offsetTop - 20, behavior: 'smooth' });
        return;
      }

      if (statusData.status === 'error') {
        clearInterval(pollTimer);
        log('✗ Error: ' + (statusData.error || 'Unknown'), 'err');
        document.getElementById('runBtn').disabled = false;
        return;
      }

      setProgress(Math.min(90, 45 + Math.floor((attempts / maxAttempts) * 45)));
      log('⏳ Processing... (' + elapsed + 's)', 'wait');

    } catch (e) {
      log('Poll error: ' + e.message, 'err');
    }

    if (attempts >= maxAttempts) {
      clearInterval(pollTimer);
      log('✗ Timed out after 3 minutes', 'err');
      document.getElementById('runBtn').disabled = false;
    }
  }, 3000);
}

function downloadReport() {
  if (!currentHtml) return;
  var blob = new Blob([currentHtml], { type: 'text/html' });
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = 'upd8-report.html'; a.click();
  URL.revokeObjectURL(url);
}

function resetTest() {
  if (pollTimer) clearInterval(pollTimer);
  clearLog(); currentHtml = '';
  document.getElementById('reportWrap').style.display = 'none';
  document.getElementById('reportFrame').srcdoc = '';
  document.getElementById('screenshot').value = '';
  document.getElementById('runBtn').disabled = false;
  setProgress(0);
}
</script>
</body>
</html>
