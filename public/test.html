<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>UPD8.GROUP — Engine Test</title>
    <style>
        body { font-family: monospace; max-width: 800px; margin: 40px auto; padding: 0 24px; background: #0f1117; color: #e2e8f0; }
        h1 { color: #22c55e; font-size: 20px; }
        label { display: block; margin: 20px 0 6px; color: #94a3b8; font-size: 13px; }
        input, select { width: 100%; padding: 10px; background: #1a1d27; border: 1px solid #2d3148; color: #e2e8f0; border-radius: 6px; font-family: monospace; font-size: 13px; box-sizing: border-box; }
        button { margin-top: 20px; padding: 12px 28px; background: #16803c; color: #fff; border: none; border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; }
        button:hover { background: #14662f; }
        button:disabled { background: #374151; cursor: not-allowed; }
        #status { margin-top: 20px; padding: 14px; background: #1a1d27; border-left: 3px solid #22c55e; border-radius: 4px; font-size: 13px; line-height: 1.8; display: none; white-space: pre-wrap; }
        #status.error { border-color: #ef4444; }
        #output { margin-top: 16px; padding: 16px; background: #0a0d14; border: 1px solid #2d3148; border-radius: 6px; font-size: 12px; line-height: 1.6; white-space: pre-wrap; word-break: break-all; display: none; max-height: 600px; overflow-y: auto; }
        .step { color: #22c55e; }
        .err  { color: #ef4444; }
    </style>
</head>
<body>

<h1>UPD8.GROUP — Engine Test</h1>
<p style="color:#64748b;font-size:13px;">Drop in your API key and a screenshot. Tests the full upload to analyze pipeline.</p>

<label>LISTINGLENS_API_KEY (from Bitwarden)</label>
<input type="password" id="apiKey" placeholder="ll_a3f8c2d1..." />

<label>Tier</label>
<select id="tier">
    <option value="standard">Standard</option>
    <option value="deep_dive">Deep Dive</option>
</select>

<label>Screenshot (JPG or PNG)</label>
<input type="file" id="screenshot" accept="image/jpeg,image/png,image/webp" />

<button id="btn" onclick="runTest()">Run Test</button>

<div id="status"></div>
<div id="output"></div>

<script>
async function runTest() {
    const apiKey    = document.getElementById('apiKey').value.trim();
    const tier      = document.getElementById('tier').value;
    const fileInput = document.getElementById('screenshot');
    const btn       = document.getElementById('btn');
    const status    = document.getElementById('status');
    const output    = document.getElementById('output');

    status.style.display = 'none';
    status.className = '';
    output.style.display = 'none';
    output.textContent = '';

    if (!apiKey)            return showStatus('Please paste your LISTINGLENS_API_KEY.', true);
    if (!fileInput.files[0]) return showStatus('Please select a screenshot.', true);

    btn.disabled = true;

    try {
        showStatus('Step 1/3 — Converting screenshot...');
        const file   = fileInput.files[0];
        const base64 = await toBase64(file);

        showStatus('Step 1/3 done\nStep 2/3 — Uploading to upd8.group...');

        const uploadRes = await fetch('https://upd8.group/.netlify/functions/upload', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-upd8-key': apiKey,
            },
            body: JSON.stringify({
                image_base64: base64,
                mime_type: file.type,
            }),
        });

        const uploadData = await uploadRes.json();
        if (!uploadRes.ok) throw new Error('Upload failed: ' + uploadData.error);

        const { session_id, blob_id, expires_at } = uploadData;
        showStatus('Step 2/3 done\n  session_id: ' + session_id + '\n  blob_id:    ' + blob_id + '\n  expires:    ' + expires_at + '\n\nStep 3/3 — Analysing with Claude (15-30 seconds)...');

        const analyzeRes = await fetch('https://upd8.group/.netlify/functions/analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-upd8-key': apiKey,
            },
            body: JSON.stringify({ session_id, blob_id, tier }),
        });

        const analyzeData = await analyzeRes.json();
        if (!analyzeRes.ok) throw new Error('Analysis failed: ' + analyzeData.error);

        showStatus('All steps complete — report received below');
        output.style.display = 'block';
        output.textContent = JSON.stringify(analyzeData.report, null, 2);

    } catch (err) {
        showStatus('Error: ' + err.message, true);
    } finally {
        btn.disabled = false;
    }
}

function toBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload  = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

function showStatus(text, isError) {
    const status = document.getElementById('status');
    status.style.display = 'block';
    status.className = isError ? 'error' : '';
    status.textContent = text;
}
</script>

</body>
</html>
